<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Manage trading alerts - OPTIX Options Trading Platform">
  <title>Alerts - OPTIX</title>
  <link rel="stylesheet" href="../assets/css/optix-design-system.css">
  <style>
    /* Alert Status Styles */
    .alert-status-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--optix-space-xs);
      padding: 4px 12px;
      border-radius: var(--optix-radius-full);
      font-size: var(--optix-font-xs);
      font-weight: var(--optix-font-medium);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .alert-status-badge.status-active {
      background: var(--optix-bg-elevated);
      color: var(--optix-text);
      border: 1px solid var(--optix-border);
    }

    .alert-status-badge.status-triggered {
      background: var(--optix-green-bg);
      color: var(--optix-green);
      border: 1px solid var(--optix-green);
    }

    .alert-status-badge.status-expired {
      background: var(--optix-bg-dark);
      color: var(--optix-text-dim);
      border: 1px solid var(--optix-border);
      opacity: 0.6;
    }

    .alert-status-badge.status-paused {
      background: var(--optix-yellow-bg);
      color: var(--optix-yellow);
      border: 1px solid var(--optix-yellow);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: var(--optix-radius-full);
    }

    .status-active .status-dot {
      background: var(--optix-blue);
      box-shadow: 0 0 8px var(--optix-blue);
    }

    .status-triggered .status-dot {
      background: var(--optix-green);
      box-shadow: 0 0 8px var(--optix-green);
    }

    .status-expired .status-dot,
    .status-paused .status-dot {
      background: var(--optix-text-dim);
    }

    /* Alert Cards */
    .alert-card {
      position: relative;
      padding: var(--optix-space-md);
      background: var(--optix-bg-elevated);
      border-radius: var(--optix-radius-md);
      border-left: 3px solid var(--optix-border);
      transition: all var(--optix-transition-fast);
    }

    .alert-card.active {
      border-left-color: var(--optix-blue);
    }

    .alert-card.triggered {
      border-left-color: var(--optix-green);
      background: rgba(16, 185, 129, 0.05);
    }

    .alert-card.expired {
      border-left-color: var(--optix-text-dim);
      opacity: 0.6;
    }

    .alert-card.paused {
      border-left-color: var(--optix-yellow);
    }

    .alert-card:hover {
      background: var(--optix-bg-hover);
    }

    .alert-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--optix-space-md);
      margin-bottom: var(--optix-space-sm);
    }

    .alert-symbol {
      font-size: var(--optix-font-lg);
      font-weight: var(--optix-font-bold);
      font-family: var(--optix-font-mono);
      color: var(--optix-text);
    }

    .alert-condition {
      font-size: var(--optix-font-base);
      color: var(--optix-text-muted);
      margin-bottom: var(--optix-space-sm);
    }

    .alert-meta {
      display: flex;
      flex-wrap: wrap;
      gap: var(--optix-space-md);
      align-items: center;
      font-size: var(--optix-font-sm);
      color: var(--optix-text-dim);
    }

    .alert-actions {
      display: flex;
      gap: var(--optix-space-xs);
    }

    .alert-list {
      display: flex;
      flex-direction: column;
      gap: var(--optix-space-md);
    }

    /* Template Cards */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--optix-space-md);
      margin-bottom: var(--optix-space-lg);
    }

    .template-card {
      padding: var(--optix-space-md);
      background: var(--optix-bg-elevated);
      border-radius: var(--optix-radius-md);
      border: 1px solid var(--optix-border);
      cursor: pointer;
      transition: all var(--optix-transition-fast);
    }

    .template-card:hover {
      background: var(--optix-bg-hover);
      border-color: var(--optix-primary);
      transform: translateY(-2px);
    }

    .template-icon {
      width: 40px;
      height: 40px;
      background: var(--optix-primary-bg);
      color: var(--optix-primary);
      border-radius: var(--optix-radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--optix-space-sm);
    }

    .template-title {
      font-weight: var(--optix-font-semibold);
      margin-bottom: var(--optix-space-xs);
    }

    .template-description {
      font-size: var(--optix-font-sm);
      color: var(--optix-text-muted);
    }

    /* Form Sections */
    .form-section {
      margin-bottom: var(--optix-space-lg);
      padding-bottom: var(--optix-space-lg);
      border-bottom: 1px solid var(--optix-border);
    }

    .form-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .section-title {
      font-size: var(--optix-font-lg);
      font-weight: var(--optix-font-semibold);
      margin-bottom: var(--optix-space-md);
      color: var(--optix-text);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: var(--optix-space-md);
      margin-bottom: var(--optix-space-md);
    }

    .form-row:last-child {
      margin-bottom: 0;
    }

    /* Toggle Switches */
    .notification-toggles {
      display: flex;
      flex-wrap: wrap;
      gap: var(--optix-space-lg);
    }

    .toggle-group {
      display: flex;
      align-items: center;
      gap: var(--optix-space-sm);
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--optix-bg-dark);
      border-radius: var(--optix-radius-full);
      cursor: pointer;
      transition: background var(--optix-transition-fast);
      border: 1px solid var(--optix-border);
    }

    .toggle-switch.active {
      background: var(--optix-primary);
      border-color: var(--optix-primary);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: var(--optix-radius-full);
      transition: transform var(--optix-transition-fast);
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    .toggle-label {
      font-size: var(--optix-font-sm);
      font-weight: var(--optix-font-medium);
      cursor: pointer;
    }

    /* Stats */
    .alert-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--optix-space-md);
      margin-bottom: var(--optix-space-lg);
    }

    .stat-card {
      padding: var(--optix-space-md);
      background: var(--optix-bg-elevated);
      border-radius: var(--optix-radius-md);
      border: 1px solid var(--optix-border);
    }

    .stat-label {
      font-size: var(--optix-font-sm);
      color: var(--optix-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--optix-space-xs);
    }

    .stat-value {
      font-size: var(--optix-font-2xl);
      font-weight: var(--optix-font-bold);
      font-family: var(--optix-font-mono);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--optix-space-2xl);
      color: var(--optix-text-muted);
    }

    .empty-state-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto var(--optix-space-lg);
      opacity: 0.5;
    }

    /* Autocomplete */
    .autocomplete-container {
      position: relative;
    }

    .autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--optix-bg-elevated);
      border: 1px solid var(--optix-border);
      border-radius: var(--optix-radius-md);
      margin-top: 4px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .autocomplete-results.active {
      display: block;
    }

    .autocomplete-item {
      padding: var(--optix-space-sm) var(--optix-space-md);
      cursor: pointer;
      transition: background var(--optix-transition-fast);
      border-bottom: 1px solid var(--optix-border);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background: var(--optix-bg-hover);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .alert-card-header {
        flex-direction: column;
      }

      .alert-actions {
        width: 100%;
        flex-wrap: wrap;
      }

      .template-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div id="sidebar-container"></div>

    <main class="main-content">
      <div id="header-container"></div>

      <div class="page-container">
        <!-- Page Header -->
        <div class="page-header">
          <h1 class="page-title">Alerts</h1>
          <button id="create-alert-btn" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 4a.5.5 0 01.5.5v3h3a.5.5 0 010 1h-3v3a.5.5 0 01-1 0v-3h-3a.5.5 0 010-1h3v-3A.5.5 0 018 4z"/>
            </svg>
            Create Alert
          </button>
        </div>

        <!-- Alert Statistics -->
        <div class="alert-stats" id="alert-stats">
          <div class="stat-card">
            <div class="stat-label">Active Alerts</div>
            <div class="stat-value" id="stat-active">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Triggered Today</div>
            <div class="stat-value text-green" id="stat-triggered">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Alerts</div>
            <div class="stat-value" id="stat-total">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Success Rate</div>
            <div class="stat-value text-muted" id="stat-success-rate">0%</div>
          </div>
        </div>

        <!-- Quick Templates -->
        <div class="card" style="margin-bottom: var(--optix-space-lg);">
          <div class="card-header">
            <h2 class="card-title">Quick Templates</h2>
          </div>
          <div class="card-body">
            <div class="template-grid" id="templates-grid">
              <!-- Templates will be inserted here -->
            </div>
          </div>
        </div>

        <!-- Active Alerts -->
        <div class="card" style="margin-bottom: var(--optix-space-lg);">
          <div class="card-header">
            <h2 class="card-title">Active Alerts</h2>
            <div class="flex gap-sm">
              <button id="refresh-alerts-btn" class="btn btn-secondary btn-sm">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M8 3a5 5 0 104.546 2.914.5.5 0 01.908-.417A6 6 0 118 2v1z"/>
                  <path d="M8 4.466V.534a.25.25 0 01.41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 018 4.466z"/>
                </svg>
                Refresh
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="alert-list" id="active-alerts-list">
              <!-- Active alerts will be inserted here -->
            </div>
          </div>
        </div>

        <!-- Alert History -->
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Alert History</h2>
            <button id="clear-history-btn" class="btn btn-ghost btn-sm">Clear History</button>
          </div>
          <div class="card-body">
            <div class="alert-list" id="alert-history-list">
              <!-- Alert history will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Create/Edit Alert Modal -->
  <div id="alert-modal" class="modal-overlay">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 id="modal-title">Create Alert</h3>
        <button class="btn btn-ghost btn-icon" id="close-alert-modal" aria-label="Close">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4.646 4.646a.5.5 0 01.708 0L8 7.293l2.646-2.647a.5.5 0 01.708.708L8.707 8l2.647 2.646a.5.5 0 01-.708.708L8 8.707l-2.646 2.647a.5.5 0 01-.708-.708L7.293 8 4.646 5.354a.5.5 0 010-.708z"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="alert-form">
          <!-- Symbol Selection -->
          <div class="form-section">
            <div class="section-title">Symbol</div>
            <div class="form-group">
              <label for="alert-symbol" class="form-label">Stock Symbol</label>
              <div class="autocomplete-container">
                <input
                  type="text"
                  id="alert-symbol"
                  class="form-input"
                  placeholder="e.g., AAPL, TSLA, SPY"
                  autocomplete="off"
                  required
                  style="text-transform: uppercase;"
                >
                <div class="autocomplete-results" id="symbol-autocomplete"></div>
              </div>
            </div>
          </div>

          <!-- Alert Conditions -->
          <div class="form-section">
            <div class="section-title">Alert Condition</div>
            <div class="form-row">
              <div class="form-group">
                <label for="alert-type" class="form-label">Alert Type</label>
                <select id="alert-type" class="form-select" required>
                  <option value="">Select type...</option>
                  <option value="price_above">Price Above</option>
                  <option value="price_below">Price Below</option>
                  <option value="percent_change">% Change</option>
                  <option value="volume_spike">Volume Spike</option>
                  <option value="iv_change">IV Change</option>
                  <option value="gex_level">GEX Level</option>
                </select>
              </div>
              <div class="form-group">
                <label for="alert-value" class="form-label">Condition Value</label>
                <input
                  type="number"
                  id="alert-value"
                  class="form-input"
                  placeholder="e.g., 150.00"
                  step="0.01"
                  required
                >
              </div>
            </div>
          </div>

          <!-- Notification Methods -->
          <div class="form-section">
            <div class="section-title">Notification Method</div>
            <div class="notification-toggles">
              <div class="toggle-group">
                <div class="toggle-switch active" id="toggle-push" data-method="push"></div>
                <label class="toggle-label" for="toggle-push">Push Notification</label>
              </div>
              <div class="toggle-group">
                <div class="toggle-switch" id="toggle-email" data-method="email"></div>
                <label class="toggle-label" for="toggle-email">Email</label>
              </div>
              <div class="toggle-group">
                <div class="toggle-switch" id="toggle-sms" data-method="sms"></div>
                <label class="toggle-label" for="toggle-sms">SMS</label>
              </div>
            </div>
          </div>

          <!-- Expiration -->
          <div class="form-section">
            <div class="section-title">Expiration</div>
            <div class="form-row">
              <div class="form-group">
                <label for="alert-expiration" class="form-label">Expiration Type</label>
                <select id="alert-expiration" class="form-select" required>
                  <option value="one_time">One-time</option>
                  <option value="recurring">Recurring</option>
                  <option value="until_date">Until Date</option>
                </select>
              </div>
              <div class="form-group" id="expiration-date-group" style="display: none;">
                <label for="alert-expiration-date" class="form-label">Expiration Date</label>
                <input
                  type="date"
                  id="alert-expiration-date"
                  class="form-input"
                >
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancel-alert-btn">Cancel</button>
        <button class="btn btn-primary" id="save-alert-btn">Create Alert</button>
      </div>
    </div>
  </div>

  <script src="../assets/js/optix-data-bridge.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/component-loader.js"></script>
  <script>
    // State management
    let alerts = [];
    let alertHistory = [];
    let editingAlertId = null;
    const notificationMethods = new Set(['push']); // Default to push notifications

    // Quick Templates
    const templates = [
      {
        id: 'price_drop_5',
        title: 'Price Drop Alert',
        description: 'Alert when price drops 5%',
        icon: '<path d="M8 4a.5.5 0 01.5.5v5.793l2.146-2.147a.5.5 0 01.708.708l-3 3a.5.5 0 01-.708 0l-3-3a.5.5 0 11.708-.708L7.5 10.293V4.5A.5.5 0 018 4z"/>',
        config: { type: 'percent_change', value: -5 }
      },
      {
        id: 'price_gain_5',
        title: 'Price Gain Alert',
        description: 'Alert when price gains 5%',
        icon: '<path d="M8 12a.5.5 0 00.5-.5V5.707l2.146 2.147a.5.5 0 00.708-.708l-3-3a.5.5 0 00-.708 0l-3 3a.5.5 0 10.708.708L7.5 5.707V11.5a.5.5 0 00.5.5z"/>',
        config: { type: 'percent_change', value: 5 }
      },
      {
        id: 'volume_spike',
        title: 'Volume Spike',
        description: 'Alert on 200% volume increase',
        icon: '<path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zm6-4a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zm6-3a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>',
        config: { type: 'volume_spike', value: 200 }
      },
      {
        id: 'iv_spike',
        title: 'IV Spike',
        description: 'Alert on 25% IV increase',
        icon: '<path d="M8 2a.5.5 0 01.5.5v11.793l3.146-3.147a.5.5 0 01.708.708l-4 4a.5.5 0 01-.708 0l-4-4a.5.5 0 01.708-.708L7.5 14.293V2.5A.5.5 0 018 2z"/>',
        config: { type: 'iv_change', value: 25 }
      }
    ];

    // Initialize page
    async function init() {
      // Load layout
      await OPTIXComponentLoader.loadLayout();

      // Render templates
      renderTemplates();

      // Load alerts
      await loadAlerts();

      // Set up event listeners
      setupEventListeners();

      // Auto-refresh every 30 seconds
      setInterval(loadAlerts, 30000);
    }

    // Render quick templates
    function renderTemplates() {
      const grid = document.getElementById('templates-grid');
      grid.innerHTML = templates.map(template => `
        <div class="template-card" onclick="applyTemplate('${template.id}')">
          <div class="template-icon">
            <svg width="24" height="24" viewBox="0 0 16 16" fill="currentColor">
              ${template.icon}
            </svg>
          </div>
          <div class="template-title">${template.title}</div>
          <div class="template-description">${template.description}</div>
        </div>
      `).join('');
    }

    // Apply template
    function applyTemplate(templateId) {
      const template = templates.find(t => t.id === templateId);
      if (!template) return;

      openAlertModal();
      document.getElementById('alert-type').value = template.config.type;
      document.getElementById('alert-value').value = Math.abs(template.config.value);
      document.getElementById('alert-symbol').focus();
    }

    // Load alerts
    async function loadAlerts() {
      try {
        const data = await OPTIXDataBridge.alerts.getAll();
        alerts = data.filter(a => a.status === 'active' || a.status === 'paused');
        alertHistory = data.filter(a => a.status === 'triggered' || a.status === 'expired').slice(0, 10);

        updateStats();
        renderActiveAlerts();
        renderAlertHistory();
      } catch (error) {
        console.error('Failed to load alerts:', error);
        showError('Failed to load alerts');
      }
    }

    // Update statistics
    function updateStats() {
      const activeCount = alerts.filter(a => a.status === 'active').length;
      const triggeredToday = alertHistory.filter(a => {
        if (a.status !== 'triggered') return false;
        const today = new Date().toDateString();
        const alertDate = new Date(a.triggered_at || a.updated_at).toDateString();
        return today === alertDate;
      }).length;
      const totalCount = alerts.length + alertHistory.length;
      const successRate = totalCount > 0
        ? Math.round((alertHistory.filter(a => a.status === 'triggered').length / totalCount) * 100)
        : 0;

      document.getElementById('stat-active').textContent = activeCount;
      document.getElementById('stat-triggered').textContent = triggeredToday;
      document.getElementById('stat-total').textContent = totalCount;
      document.getElementById('stat-success-rate').textContent = `${successRate}%`;
    }

    // Render active alerts
    function renderActiveAlerts() {
      const container = document.getElementById('active-alerts-list');

      if (alerts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg class="empty-state-icon" viewBox="0 0 80 80" fill="currentColor">
              <path d="M40 10a30 30 0 00-30 30v10.586l-7.071 7.071A1 1 0 003 58h74a1 1 0 00.071-.343L70 50.586V40a30 30 0 00-30-30zm0 60a10 10 0 01-10-10h20a10 10 0 01-10 10z"/>
            </svg>
            <h3>No active alerts</h3>
            <p class="text-muted">Create your first alert to get notified of market movements</p>
            <button class="btn btn-primary mt-lg" onclick="openAlertModal()">Create Alert</button>
          </div>
        `;
        return;
      }

      container.innerHTML = alerts.map(alert => renderAlertCard(alert)).join('');
    }

    // Render alert history
    function renderAlertHistory() {
      const container = document.getElementById('alert-history-list');

      if (alertHistory.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <p class="text-muted">No alert history yet</p>
          </div>
        `;
        return;
      }

      container.innerHTML = alertHistory.map(alert => renderAlertCard(alert, true)).join('');
    }

    // Render alert card
    function renderAlertCard(alert, isHistory = false) {
      const statusClass = alert.status || 'active';
      const condition = formatCondition(alert);
      const methods = formatNotificationMethods(alert.notification_methods || ['push']);
      const createdDate = formatDate(alert.created_at);
      const triggeredDate = alert.triggered_at ? formatDate(alert.triggered_at) : null;

      return `
        <div class="alert-card ${statusClass}" data-id="${alert.id}">
          <div class="alert-card-header">
            <div>
              <div class="alert-symbol">${alert.symbol}</div>
              <div class="alert-condition">${condition}</div>
            </div>
            <div class="alert-actions">
              ${!isHistory ? `
                <button class="btn btn-ghost btn-icon" onclick="toggleAlertStatus('${alert.id}')" title="${alert.status === 'paused' ? 'Resume' : 'Pause'}">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    ${alert.status === 'paused'
                      ? '<path d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z"/><path d="M6.271 5.055a.5.5 0 01.52.038l3.5 2.5a.5.5 0 010 .814l-3.5 2.5A.5.5 0 016 10.5v-5a.5.5 0 01.271-.445z"/>'
                      : '<path d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z"/><path d="M5 6.25a1.25 1.25 0 112.5 0v3.5a1.25 1.25 0 11-2.5 0v-3.5zm3.5 0a1.25 1.25 0 112.5 0v3.5a1.25 1.25 0 11-2.5 0v-3.5z"/>'
                    }
                  </svg>
                </button>
                <button class="btn btn-ghost btn-icon" onclick="editAlert('${alert.id}')" title="Edit">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M12.854.146a.5.5 0 00-.707 0L10.5 1.793 14.207 5.5l1.647-1.646a.5.5 0 000-.708l-3-3zm.646 6.061L9.793 2.5 3.293 9H3.5a.5.5 0 01.5.5v.5h.5a.5.5 0 01.5.5v.5h.5a.5.5 0 01.5.5v.5h.5a.5.5 0 01.5.5v.207l6.5-6.5z"/>
                  </svg>
                </button>
              ` : ''}
              <button class="btn btn-ghost btn-icon" onclick="deleteAlert('${alert.id}')" title="Delete">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M5.5 5.5A.5.5 0 016 6v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm2.5 0a.5.5 0 01.5.5v6a.5.5 0 01-1 0V6a.5.5 0 01.5-.5zm3 .5a.5.5 0 00-1 0v6a.5.5 0 001 0V6z"/>
                  <path d="M14.5 3a1 1 0 01-1 1H13v9a2 2 0 01-2 2H5a2 2 0 01-2-2V4h-.5a1 1 0 01-1-1V2a1 1 0 011-1H6a1 1 0 011-1h2a1 1 0 011 1h3.5a1 1 0 011 1v1zM4.118 4L4 4.059V13a1 1 0 001 1h6a1 1 0 001-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="alert-meta">
            <span class="alert-status-badge status-${statusClass}">
              <span class="status-dot"></span>
              ${alert.status}
            </span>
            <span>${methods}</span>
            <span>Created ${createdDate}</span>
            ${triggeredDate ? `<span class="text-green">Triggered ${triggeredDate}</span>` : ''}
          </div>
        </div>
      `;
    }

    // Format alert condition
    function formatCondition(alert) {
      const type = alert.type || alert.alert_type;
      const value = alert.value || alert.condition_value;

      switch (type) {
        case 'price_above':
          return `Price above $${value}`;
        case 'price_below':
          return `Price below $${value}`;
        case 'percent_change':
          return `${value > 0 ? '+' : ''}${value}% change`;
        case 'volume_spike':
          return `Volume spike ${value}%`;
        case 'iv_change':
          return `IV change ${value}%`;
        case 'gex_level':
          return `GEX level ${value}`;
        default:
          return `${type}: ${value}`;
      }
    }

    // Format notification methods
    function formatNotificationMethods(methods) {
      const icons = {
        push: 'ðŸ””',
        email: 'ðŸ“§',
        sms: 'ðŸ“±'
      };
      return methods.map(m => icons[m] || m).join(' ');
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    // Setup event listeners
    function setupEventListeners() {
      // Modal controls
      document.getElementById('create-alert-btn').onclick = openAlertModal;
      document.getElementById('close-alert-modal').onclick = closeAlertModal;
      document.getElementById('cancel-alert-btn').onclick = closeAlertModal;
      document.getElementById('save-alert-btn').onclick = saveAlert;

      // Refresh
      document.getElementById('refresh-alerts-btn').onclick = loadAlerts;

      // Clear history
      document.getElementById('clear-history-btn').onclick = clearHistory;

      // Toggle switches
      document.querySelectorAll('.toggle-switch').forEach(toggle => {
        toggle.onclick = function() {
          this.classList.toggle('active');
          const method = this.dataset.method;
          if (this.classList.contains('active')) {
            notificationMethods.add(method);
          } else {
            notificationMethods.delete(method);
          }
        };
      });

      // Expiration type change
      document.getElementById('alert-expiration').onchange = function() {
        const dateGroup = document.getElementById('expiration-date-group');
        dateGroup.style.display = this.value === 'until_date' ? 'block' : 'none';
      };

      // Symbol autocomplete
      setupSymbolAutocomplete();

      // Close modal on overlay click
      document.getElementById('alert-modal').onclick = function(e) {
        if (e.target === this) closeAlertModal();
      };

      // Close modal on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeAlertModal();
      });
    }

    // Symbol autocomplete
    function setupSymbolAutocomplete() {
      const input = document.getElementById('alert-symbol');
      const results = document.getElementById('symbol-autocomplete');
      let timeout;

      input.oninput = function() {
        const query = this.value.trim().toUpperCase();
        this.value = query;

        clearTimeout(timeout);
        results.classList.remove('active');

        if (query.length < 1) return;

        timeout = setTimeout(async () => {
          try {
            // In a real implementation, this would search for symbols
            // For now, we'll show a simple list
            const suggestions = ['AAPL', 'TSLA', 'SPY', 'QQQ', 'MSFT', 'GOOGL', 'AMZN', 'META', 'NVDA', 'AMD']
              .filter(s => s.startsWith(query))
              .slice(0, 5);

            if (suggestions.length > 0) {
              results.innerHTML = suggestions.map(symbol =>
                `<div class="autocomplete-item" onclick="selectSymbol('${symbol}')">${symbol}</div>`
              ).join('');
              results.classList.add('active');
            }
          } catch (error) {
            console.error('Autocomplete error:', error);
          }
        }, 300);
      };

      // Close on click outside
      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !results.contains(e.target)) {
          results.classList.remove('active');
        }
      });
    }

    // Select symbol from autocomplete
    function selectSymbol(symbol) {
      document.getElementById('alert-symbol').value = symbol;
      document.getElementById('symbol-autocomplete').classList.remove('active');
    }

    // Open alert modal
    function openAlertModal() {
      editingAlertId = null;
      document.getElementById('modal-title').textContent = 'Create Alert';
      document.getElementById('save-alert-btn').textContent = 'Create Alert';
      document.getElementById('alert-form').reset();
      notificationMethods.clear();
      notificationMethods.add('push');
      updateToggleSwitches();
      document.getElementById('alert-modal').classList.add('active');
      document.getElementById('alert-symbol').focus();
    }

    // Close alert modal
    function closeAlertModal() {
      document.getElementById('alert-modal').classList.remove('active');
      editingAlertId = null;
    }

    // Edit alert
    function editAlert(id) {
      const alert = alerts.find(a => a.id === id);
      if (!alert) return;

      editingAlertId = id;
      document.getElementById('modal-title').textContent = 'Edit Alert';
      document.getElementById('save-alert-btn').textContent = 'Save Changes';

      document.getElementById('alert-symbol').value = alert.symbol;
      document.getElementById('alert-type').value = alert.type || alert.alert_type;
      document.getElementById('alert-value').value = alert.value || alert.condition_value;
      document.getElementById('alert-expiration').value = alert.expiration_type || 'one_time';

      if (alert.expiration_date) {
        document.getElementById('alert-expiration-date').value = alert.expiration_date;
        document.getElementById('expiration-date-group').style.display = 'block';
      }

      notificationMethods.clear();
      (alert.notification_methods || ['push']).forEach(m => notificationMethods.add(m));
      updateToggleSwitches();

      document.getElementById('alert-modal').classList.add('active');
    }

    // Update toggle switches to match state
    function updateToggleSwitches() {
      document.querySelectorAll('.toggle-switch').forEach(toggle => {
        const method = toggle.dataset.method;
        toggle.classList.toggle('active', notificationMethods.has(method));
      });
    }

    // Save alert
    async function saveAlert() {
      const form = document.getElementById('alert-form');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const symbol = document.getElementById('alert-symbol').value.trim().toUpperCase();
      const type = document.getElementById('alert-type').value;
      const value = parseFloat(document.getElementById('alert-value').value);
      const expirationType = document.getElementById('alert-expiration').value;
      const expirationDate = document.getElementById('alert-expiration-date').value;

      if (notificationMethods.size === 0) {
        alert('Please select at least one notification method');
        return;
      }

      const alertData = {
        symbol,
        type,
        value,
        notification_methods: Array.from(notificationMethods),
        expiration_type: expirationType,
        expiration_date: expirationType === 'until_date' ? expirationDate : null,
        status: 'active'
      };

      try {
        const btn = document.getElementById('save-alert-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px;"></span>';

        if (editingAlertId) {
          await OPTIXDataBridge.alerts.update(editingAlertId, alertData);
        } else {
          await OPTIXDataBridge.alerts.create(alertData);
        }

        closeAlertModal();
        await loadAlerts();
        showSuccess(editingAlertId ? 'Alert updated' : 'Alert created');
      } catch (error) {
        console.error('Failed to save alert:', error);
        showError('Failed to save alert: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = editingAlertId ? 'Save Changes' : 'Create Alert';
      }
    }

    // Toggle alert status (pause/resume)
    async function toggleAlertStatus(id) {
      const alert = alerts.find(a => a.id === id);
      if (!alert) return;

      const newStatus = alert.status === 'paused' ? 'active' : 'paused';

      try {
        await OPTIXDataBridge.alerts.update(id, { status: newStatus });
        await loadAlerts();
        showSuccess(`Alert ${newStatus === 'paused' ? 'paused' : 'resumed'}`);
      } catch (error) {
        console.error('Failed to toggle alert:', error);
        showError('Failed to update alert');
      }
    }

    // Delete alert
    async function deleteAlert(id) {
      if (!confirm('Are you sure you want to delete this alert?')) return;

      try {
        await OPTIXDataBridge.alerts.delete(id);
        await loadAlerts();
        showSuccess('Alert deleted');
      } catch (error) {
        console.error('Failed to delete alert:', error);
        showError('Failed to delete alert');
      }
    }

    // Clear history
    async function clearHistory() {
      if (!confirm('Are you sure you want to clear all alert history?')) return;

      try {
        await OPTIXDataBridge.alerts.clearHistory();
        await loadAlerts();
        showSuccess('Alert history cleared');
      } catch (error) {
        console.error('Failed to clear history:', error);
        showError('Failed to clear history');
      }
    }

    // Show success message
    function showSuccess(message) {
      showToast(message, 'success');
    }

    // Show error message
    function showError(message) {
      showToast(message, 'error');
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type}`;
      toast.style.cssText = 'position: fixed; top: 80px; right: 24px; z-index: 1000; min-width: 300px; animation: slideIn 0.3s ease;';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize
    init();
  </script>
</body>
</html>
